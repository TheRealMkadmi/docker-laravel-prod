#!/usr/bin/env bash
set -e

# Better error handling with logging
error_handler() {
    local line=$1
    local command=$2
    local code=$3
    echo "ERROR: Command '$command' exited with status $code at line $line" >&2
    # Record error in dedicated log file for startup errors
    echo "$(date +"%Y-%m-%d %H:%M:%S") - STARTUP ERROR: Command '$command' exited with status $code at line $line" >> /tmp/container_startup_errors.log
    # Don't exit, let supervisord handle restarts
}
trap 'error_handler ${LINENO} "$BASH_COMMAND" $?' ERR

# Set environment variables with defaults
container_mode=${CONTAINER_MODE:-"http"}
octane_server=${OCTANE_SERVER:-"swoole"}
running_migrations_and_seeders=${RUNNING_MIGRATIONS_AND_SEEDERS:-"false"}
artisan_cache=${ARTISAN_CACHE:-"true"}

# Log startup information
echo "ğŸš€ Starting container in $container_mode mode"
echo "ğŸ”§ Using Octane server: $octane_server"
echo "ğŸ—„ï¸ Running migrations and seeders: $running_migrations_and_seeders"
echo "ğŸ“¦ Using artisan cache: $artisan_cache"

# Start 502 error monitoring in background
if [ -f "/usr/local/bin/utilities.sh" ]; then
    echo "ğŸ” Starting 502 error monitoring..."
    bash /usr/local/bin/utilities.sh monitor >> /dev/stdout 2>> /dev/stderr &
fi

initialStuff() {
    echo "ğŸ“‹ Running initialization tasks..."
    
    # Check PHP installation and display version
    echo "ğŸ” PHP version check:"
    php --version || echo "âš ï¸ Warning: PHP version check failed"
    
    if [ "${artisan_cache}" = "true" ]; then
        echo "ğŸ§¹ Clearing and rebuilding cache..."
        php artisan optimize:clear || { 
            echo "âš ï¸ Warning: optimize:clear failed, capturing error details" 
            php -d display_errors=stderr artisan optimize:clear --verbose
        }
        php artisan event:cache || echo "âš ï¸ Warning: event:cache failed but continuing..."
        php artisan config:cache || echo "âš ï¸ Warning: config:cache failed but continuing..."
        php artisan route:cache || echo "âš ï¸ Warning: route:cache failed but continuing..."
        echo "âœ… Cache operations completed"
    fi

    if [ "${running_migrations_and_seeders}" = "true" ]; then
        echo "ğŸ—„ï¸ Running migrations and seeding database..."
        php artisan migrate --isolated --seed --force || {
            echo "âŒ ERROR: Migrations failed, capturing error details"
            php -d display_errors=stderr artisan migrate --isolated --seed --force -vvv
            echo "âš ï¸ Continuing despite migration errors..."
        }
        echo "âœ… Database operations completed"
    fi
    
    # Check for storage directory permissions
    for dir in storage/framework/cache storage/framework/sessions storage/framework/views storage/logs bootstrap/cache; do
        if [ ! -d "$dir" ]; then
            echo "ğŸ“ Creating directory: $dir"
            mkdir -p "$dir"
        fi
        echo "ğŸ” Setting permissions for $dir"
        chmod -R 755 "$dir"
        touch "$dir/.keep"
    done
    
    # Verify logs directory is writable for detailed error logs
    if [ -d "storage/logs" ]; then
        echo "ğŸ“ Verifying logs directory is writable"
        touch storage/logs/laravel-$(date +"%Y-%m-%d").log
        echo "$(date +"%Y-%m-%d %H:%M:%S") [INFO] Container startup" >> storage/logs/laravel-$(date +"%Y-%m-%d").log
        chmod -R 755 storage/logs
    fi
    
    # Verify Octane is available
    echo "ğŸ” Verifying Octane installation..."
    php artisan octane:status || echo "âš ï¸ Warning: Octane status check failed"
    
    # Copy utilities script to be accessible
    if [ -f "/var/www/html/deployment/utilities.sh" ]; then
        echo "ğŸ”§ Installing utility scripts..."
        cp /var/www/html/deployment/utilities.sh /usr/local/bin/
        chmod +x /usr/local/bin/utilities.sh
    fi
}

if [ "$1" != "" ]; then
    echo "âš™ï¸ Executing custom command: $@"
    exec "$@"
elif [ "${container_mode}" = "http" ]; then
    echo "ğŸŒ Starting in HTTP mode"
    echo "ğŸš€ Octane Server: $octane_server"
    initialStuff
    
    # Additional startup checks
    echo "ğŸ” Checking Laravel installation..."
    php artisan --version || { 
        echo "âš ï¸ Warning: Laravel artisan command failed" 
        # Try with error display for detailed diagnostics
        php -d display_errors=stderr artisan --version -vvv
    }
    
    # Verify nginx config
    echo "ğŸ” Verifying Nginx configuration..."
    nginx -t || echo "âš ï¸ Warning: Nginx configuration test failed"
    
    echo "âœ… Container startup completed, supervisor will start services"
fi

# Log completion of startup script
echo "ğŸ“‹ Container initialization complete, handing control to supervisord"
echo "$(date +"%Y-%m-%d %H:%M:%S") - CONTAINER_STARTUP_COMPLETE" >> /tmp/container_startup.log
